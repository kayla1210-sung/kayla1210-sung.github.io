<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>Pixel Manor RPG</title>
<style>
body { margin:0; background:#111; display:flex; justify-content:center; align-items:center; height:100vh; }
canvas { background:#000; image-rendering:pixelated; border:4px solid #444; }
#dialog { position:absolute; bottom:20px; left:50%; transform:translateX(-50%); 
         width:300px; padding:10px; background:rgba(0,0,0,0.8); color:#fff; 
         font-family:monospace; font-size:14px; display:none; border:2px solid #888; }
</style>
</head>
<body>
<canvas id="game" width="320" height="180"></canvas>
<div id="dialog"></div>

<script>
/* ===== 基本設定 ===== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const SCALE = 3;
canvas.style.width = canvas.width*SCALE+"px";
canvas.style.height = canvas.height*SCALE+"px";
const TILE=16;

/* ===== 地圖資料 ===== */
const maps = {
  hall:[
    "####################",
    "#.................>#",
    "#..######..........#",
    "#..................#",
    "#........#####.....#",
    "#..................#",
    "####################"
  ],
  corridor:[
    "####################",
    "#<.................#",
    "#.......#..........#",
    "#.......#..........#",
    "#..................#",
    "#...........>......#",
    "####################"
  ],
  artroom:[
    "####################",
    "#<.................#",
    "#..................#",
    "#...#.....#........#",
    "#...#.....#........#",
    "#..................#",
    "####################"
  ]
};
let currentMap="hall";

/* ===== 玩家 ===== */
const player={x:TILE*2,y:TILE*2,w:16,h:24,speed:1.2,dir:"down",frame:0,animTimer:0,moving:false};

/* ===== NPC 範例 ===== */
const npcs=[
  {x:TILE*10,y:TILE*2,w:16,h:24,dir:"down",frame:0,name:"Guard",msg:["你好，我是守衛","城堡很大喔"],route:[{x:10,y:2},{x:10,y:4},{x:12,y:4},{x:12,y:2}],routeIndex:0,routeTimer:0},
  {x:TILE*6,y:TILE*4,w:16,h:24,dir:"down",frame:0,name:"Painter",msg:["畫室很安靜","喜歡畫畫嗎？"],route:[{x:6,y:4}],routeIndex:0,routeTimer:0}
];

/* ===== 互動物件 ===== */
const items=[
  {x:TILE*5,y:TILE*2,w:16,h:16,name:"書",msg:"這是一本古老的書"},
  {x:TILE*8,y:TILE*3,w:16,h:16,name:"畫",msg:"這幅畫充滿色彩"},
  {x:TILE*14,y:TILE*4,w:16,h:16,name:"桌子",msg:"桌子上有幾本筆記"}
];

/* ===== 對話框 ===== */
const dialog=document.getElementById("dialog");

/* ===== 鍵盤 ===== */
const keys={};
window.addEventListener("keydown",e=>keys[e.key]=true);
window.addEventListener("keyup",e=>keys[e.key]=false);

/* ===== 玩家 & NPC Sprite ===== */
const sprite=document.createElement("canvas");
sprite.width=64; sprite.height=96;
const sctx=sprite.getContext("2d");
function drawSpriteSheet(){
  const colors={head:"#ffd966",body:"#6fa8dc",legs:"#444"};
  const dirs=["down","left","right","up"];
  dirs.forEach((dir,d)=>{
    for(let f=0;f<2;f++){
      const x=f*16,y=d*24;
      sctx.fillStyle=colors.head; sctx.fillRect(x+4,y+2,8,8);
      sctx.fillStyle=colors.body; sctx.fillRect(x+3,y+10,10,8);
      sctx.fillStyle=colors.legs; sctx.fillRect(x+4+(f*2),y+18,3,4); sctx.fillRect(x+9-(f*2),y+18,3,4);
    }
  });
}
drawSpriteSheet();

/* ===== 主迴圈 ===== */
function loop(){update();draw();requestAnimationFrame(loop);}

/* ===== 更新 ===== */
function update(){
  let nx=player.x,ny=player.y; player.moving=false;
  if(keys["ArrowUp"]||keys["w"]){ny-=player.speed;player.dir="up";player.moving=true;}
  if(keys["ArrowDown"]||keys["s"]){ny+=player.speed;player.dir="down";player.moving=true;}
  if(keys["ArrowLeft"]||keys["a"]){nx-=player.speed;player.dir="left";player.moving=true;}
  if(keys["ArrowRight"]||keys["d"]){nx+=player.speed;player.dir="right";player.moving=true;}
  if(!isWall(nx,ny)) {player.x=nx; player.y=ny;}
  animate();
  updateNPCs();
  checkExit();
  checkItems();
}

/* ===== 動畫 ===== */
function animate(){if(!player.moving){player.frame=0;return;}player.animTimer++;if(player.animTimer>10){player.frame=(player.frame+1)%2;player.animTimer=0;}}

/* ===== 牆體碰撞 ===== */
function isWall(x,y){
  const map=maps[currentMap];
  const left=Math.floor(x/TILE),right=Math.floor((x+player.w-1)/TILE);
  const top=Math.floor(y/TILE),bottom=Math.floor((y+player.h-1)/TILE);
  for(let ty=top;ty<=bottom;ty++){for(let tx=left;tx<=right;tx++){if(map[ty][tx]==="#")return true;}}
  return false;
}

/* ===== 場景切換 ===== */
function checkExit(){
  const map=maps[currentMap]; const tx=Math.floor(player.x/TILE); const ty=Math.floor(player.y/TILE); const tile=map[ty][tx];
  if(tile==">"){if(currentMap==="hall"){currentMap="corridor";player.x=TILE*2;}else if(currentMap==="corridor"){currentMap="artroom";player.x=TILE*2;}}
  if(tile=="<"){if(currentMap==="corridor"){currentMap="hall";player.x=TILE*17;}else if(currentMap==="artroom"){currentMap="corridor";player.x=TILE*17;}}
}

/* ===== NPC 行走 & 對話 ===== */
function updateNPCs(){
  npcs.forEach(npc=>{
    if(npc.route.length>1){
      npc.routeTimer++; if(npc.routeTimer>60){
        npc.routeIndex=(npc.routeIndex+1)%npc.route.length;
        npc.x=npc.route[npc.routeIndex].x*TILE; npc.y=npc.route[npc.routeIndex].y*TILE;
        npc.routeTimer=0;
      }
    }
    // 對話觸發
    if(Math.abs(player.x-npc.x)<16 && Math.abs(player.y-npc.y)<16 && keys[" "]){
      dialog.style.display="block"; dialog.innerText=npc.msg[0];
    }
  });
}

/* ===== 互動物件 ===== */
function checkItems(){
  items.forEach(item=>{
    if(Math.abs(player.x-item.x)<16 && Math.abs(player.y-item.y)<16 && keys[" "]){
      dialog.style.display="block"; dialog.innerText=item.msg;
    }
  });
}

/* ===== 繪製 ===== */
function draw(){ctx.clearRect(0,0,canvas.width,canvas.height); drawMap(); drawItems(); drawNPCs(); drawPlayer();}

/* ===== 地圖 ===== */
function drawMap(){const map=maps[currentMap];for(let y=0;y<map.length;y++){for(let x=0;x<map[y].length;x++){ctx.fillStyle=map[y][x]==="#"?"#555":"#2e2e2e"; ctx.fillRect(x*TILE,y*TILE,TILE,TILE);}}}

/* ===== 畫物件 ===== */
function drawItems(){items.forEach(item=>{ctx.fillStyle="#ff66ff"; ctx.fillRect(item.x,item.y,TILE,TILE);});}

/* ===== 畫 NPC ===== */
function drawNPCs(){npcs.forEach(npc=>{const dirIndex={down:0,left:1,right:2,up:3}[npc.dir]; ctx.drawImage(sprite,npc.frame*16,dirIndex*24,16,24,npc.x,npc.y,16,24);});}

/* ===== 畫玩家 ===== */
function drawPlayer(){const dirIndex={down:0,left:1,right:2,up:3}[player.dir]; ctx.drawImage(sprite,player.frame*16,dirIndex*24,16,24,Math.floor(player.x),Math.floor(player.y),16,24);}

loop();
</script>
</body>
</html>
